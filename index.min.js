function init(){function reset(){currMinute=2,selectedNodesList=[],svg.selectAll(".pathPoints").style("fill","none"),svg.selectAll(".selectedNodesGroup").remove(),svg.selectAll(".selectedLines").remove()}function updateNodeClick(currNode){var currData=currNode.data()[0];if(currMinute=d3.min([currMinute+1,5],function(d){return d}),svg.select("#minuteMark").text("Minute "+currMinute),currData.pathIndices.length>numPositionsMin)var currPathIndices=currData.pathIndices.slice(0,numPositionsMin);else currPathIndices=currData.pathIndices;currPositionPaths="blue"==currTeam?currPathIndices.map(function(i){return dataset_bPathList[i]}):currPathIndices.map(function(i){return dataset_rPathList[i]}),"dots"==currDisplay?plotPositions(currPositionPaths):(currHeatmapData=formatHeatmapData(currData.heatMap),heatmapInstance.setData(currHeatmapData)),selectedNodesList.push(currData.index),currNodeIndices=currMinute<5?"blue"==currTeam?dataset_bLookup[currMinute-2].nodeIndices:dataset_rLookup[currMinute-2].nodeIndices:[],plotSelectedNodes(selectedNodesList),plotNewNodes(currNodeIndices,currData.index)}function updateMouseoverRing(currNode){currNode.style("opacity",1),svg.append("circle").attr("class","nodeRings").attr("id",function(){return"blue"==currTeam?"nodeRingsBlue":"nodeRingsRed"}).attr("cx",parseFloat(currNode.attr("cx"))).attr("cy",parseFloat(currNode.attr("cy"))).attr("r",xScale_posX(750))}function plotNewNodes(currNodeIndices,parentIndex){if("blue"==currTeam)var dataset_node=dataset_bNodeList;else dataset_node=dataset_rNodeList;var nodes=svg.selectAll(".nodes").data(currNodeIndices.map(function(i){return dataset_node[i]}).filter(function(d){return d.parent==parentIndex}));nodes.exit().remove();var nodesEnter=nodes.enter().append("circle").attr("class","nodes").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",5);(nodes=nodes.merge(nodesEnter)).attr("id",function(){return"blue"==currTeam?"nodesBlue":"nodesRed"}).attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",5),svg.selectAll(".nodes").moveToFront().on("mouseover",function(){d3.select(this).attr("r",5),updateMouseoverRing(d3.select(this))}).on("mouseout",function(){svg.selectAll(".nodeRings").remove(),d3.select(this).attr("r",5).style("opacity",.8)}).on("click",function(){svg.selectAll(".nodeRings").remove(),updateNodeClick(d3.select(this))});var nodeLabels=svg.selectAll(".nodeLabels").data(currNodeIndices.map(function(i){return dataset_node[i]}).filter(function(d){return d.parent==parentIndex}));nodeLabels.exit().remove();var nodeLabelsEnter=nodeLabels.enter().append("text").attr("class","nodeLabels").attr("x",function(d){return xScale_posX(d.pos[0])}).attr("y",function(d){return yScale_posY(d.pos[1])}).text(function(d,i){return i});(nodeLabels=nodeLabels.merge(nodeLabelsEnter)).attr("id",function(){return"blue"==currTeam?"nodeLabelsBlue":"nodeLabelsRed"}).attr("x",function(d){return xScale_posX(d.pos[0])}).attr("y",function(d){return yScale_posY(d.pos[1])}).text(function(d){return d.index}).moveToFront()}function plotSelectedNodes(selectedNodesList){if("blue"==currTeam)var dataset_node=dataset_bNodeList;else dataset_node=dataset_rNodeList;if(svg.append("svg:defs").append("svg:marker").attr("id","arrow").attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",0).attr("markerWidth",12).attr("markerHeight",12).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5"),1<selectedNodesList.length){var selectedLines=svg.selectAll(".selectedLines").data(selectedNodesList.map(function(i){return dataset_node[i]}).slice(1));selectedLines.exit().remove();var selectedLinesEnter=selectedLines.enter().append("line").attr("x1",function(d,i){return xScale_posX(dataset_node[selectedNodesList[i]].pos[0])}).attr("y1",function(d,i){return yScale_posY(dataset_node[selectedNodesList[i]].pos[1])}).attr("x2",function(d,i){return xScale_posX(d.pos[0])}).attr("y2",function(d,i){return yScale_posY(d.pos[1])});(selectedLines=selectedLines.merge(selectedLinesEnter)).attr("class","selectedLines").attr("x1",function(d,i){return xScale_posX(dataset_node[selectedNodesList[i]].pos[0])}).attr("y1",function(d,i){return yScale_posY(dataset_node[selectedNodesList[i]].pos[1])}).attr("x2",function(d,i){return xScale_posX(d.pos[0])}).attr("y2",function(d,i){return yScale_posY(d.pos[1])}).attr("marker-end","url(#arrow)")}else svg.selectAll(".selectedLines").remove();var selectedNodesGroup=svg.selectAll(".selectedNodesGroup").data(selectedNodesList.map(function(i){return dataset_node[i]}));selectedNodesGroup.exit().remove(),selectedNodesGroupEnter=selectedNodesGroup.enter().append("g").attr("class","selectedNodesGroup"),selectedNodesGroupEnter.append("circle").attr("class","selectedNodes").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",5),selectedNodesGroupEnter.append("circle").attr("class","selectedNodeRings").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",8),(selectedNodesGroup=selectedNodesGroup.merge(selectedNodesGroupEnter).moveToFront()).select(".selectedNodes").attr("id",function(){return"blue"==currTeam?"selectedNodesBlue":"selectedNodesRed"}).attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",5),selectedNodesGroup.select(".selectedNodeRings").attr("id",function(){return"blue"==currTeam?"selectedNodeRingsBlue":"selectedNodeRingsRed"}).attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",8)}function plotPositions(currPositionPaths){var pathPoints=svg.selectAll(".pathPoints").data(currPositionPaths);pathPoints.exit().remove();var pathPointsEnter=pathPoints.enter().append("circle").attr("class","pathPoints").attr("cx",function(d){return xScale_posX(d.path[currMinute-2][0])}).attr("cy",function(d){return yScale_posY(d.path[currMinute-2][1])}).attr("r",2);(pathPoints=pathPoints.merge(pathPointsEnter)).attr("cx",function(d){return xScale_posX(d.path[currMinute-2][0])}).attr("cy",function(d){return yScale_posY(d.path[currMinute-2][1])}).style("fill","white")}function formatHeatmapData(dataset){return{max:d3.max(dataset,function(d){return d}),min:d3.min(dataset,function(d){return d}),data:dataset}}var currMinute,currNodeIndices,currPositionPaths,currHeatmapData,heatmapInstance,selectedNodesList,container,svg=d3.select("#graphic-svg"),w_map=document.getElementById("graphic-svg").getBoundingClientRect().width,h_map=document.getElementById("graphic-svg").getBoundingClientRect().height,xScale_posX=d3.scaleLinear().domain([0,14700]).range([0,w_map]),yScale_posY=d3.scaleLinear().domain([0,14700]).range([h_map,0]),numPositionsMin=5e3,currTeam="blue",currDisplay="dots";d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},reset(),svg.append("text").text("Minute "+currMinute).attr("id","minuteMark").attr("x",10).attr("y",25),currPositionPaths=dataset_bPathList.slice(0,numPositionsMin),svg.selectAll("pathPoints").data(currPositionPaths).enter().append("circle").attr("class","pathPoints").attr("cx",function(d){return xScale_posX(d.path[currMinute-2][0])}).attr("cy",function(d){return yScale_posY(d.path[currMinute-2][1])}).attr("r",2),currNodeIndices=dataset_bLookup[currMinute-2].nodeIndices,svg.selectAll("nodes").data(currNodeIndices.map(function(i){return dataset_bNodeList[i]})).enter().append("circle").attr("class","nodes").attr("id","nodesBlue").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}).attr("r",5).moveToFront().on("mouseover",function(){d3.select(this).attr("r",5),updateMouseoverRing(d3.select(this))}).on("mouseout",function(){svg.selectAll(".nodeRings").remove(),d3.select(this).attr("r",5).style("opacity",.8)}).on("click",function(){svg.selectAll(".nodeRings").remove(),updateNodeClick(d3.select(this))}),svg.selectAll("nodesLabel").data(currNodeIndices.map(function(i){return dataset_bNodeList[i]})).enter().append("text").attr("class","nodeLabels").attr("id","nodeLabelsBlue").attr("x",function(d){return xScale_posX(d.pos[0])}).attr("y",function(d){return yScale_posY(d.pos[1])}).text(function(d){return d.index}),currHeatmapData=formatHeatmapData(dataset_bNodeList[0].heatMap),container="heatmap-container",heatmapInstance=h337.create({container:document.getElementById(container),radius:20,maxOpacity:1,minOpacity:0,blur:.8,gradient:{.001:"purple",.2:"blue",.4:"green",.6:"yellow",.8:"orange",1:"red"}}),d3.select("#button-blue").on("click",function(){reset(),svg.select("#minuteMark").text("Minute "+currMinute),currTeam="blue",currPositionPaths=dataset_bPathList.slice(0,numPositionsMin),"dots"==currDisplay?plotPositions(currPositionPaths):(currHeatmapData=formatHeatmapData(dataset_bNodeList[0].heatMap),heatmapInstance.setData(currHeatmapData)),plotNewNodes(currNodeIndices=dataset_bLookup[currMinute-2].nodeIndices,-1),d3.select(this).style("background-color",d3.rgb(79,39,79)).style("color","white"),d3.select("#button-red").style("background-color","white").style("color",d3.rgb(79,39,79))}),d3.select("#button-red").on("click",function(){reset(),svg.select("#minuteMark").text("Minute "+currMinute),currTeam="red",currPositionPaths=dataset_rPathList.slice(0,numPositionsMin),"dots"==currDisplay?plotPositions(currPositionPaths):(currHeatmapData=formatHeatmapData(dataset_rNodeList[0].heatMap),heatmapInstance.setData(currHeatmapData)),plotNewNodes(currNodeIndices=dataset_rLookup[currMinute-2].nodeIndices,-1),d3.select(this).style("background-color",d3.rgb(79,39,79)).style("color","white"),d3.select("#button-blue").style("background-color","white").style("color",d3.rgb(79,39,79))}),d3.select("#button-back").on("click",function(){!function(){if(currMinute=d3.max([currMinute-1,2],function(d){return d}),svg.select("#minuteMark").text("Minute "+currMinute),0<selectedNodesList.length&&selectedNodesList.pop(),currNodeIndices="blue"==currTeam?dataset_bLookup[currMinute-2].nodeIndices:dataset_rLookup[currMinute-2].nodeIndices,"blue"==currTeam)var dataset_node=dataset_bNodeList,dataset_path=dataset_bPathList;else dataset_node=dataset_rNodeList,dataset_path=dataset_rPathList;if(0<selectedNodesList.length){var currNodeData=dataset_node[selectedNodesList[selectedNodesList.length-1]];if(currNodeData.pathIndices.length>numPositionsMin)var currPathIndices=currNodeData.pathIndices.slice(0,numPositionsMin);else currPathIndices=currNodeData.pathIndices;currPositionPaths=currPathIndices.map(function(i){return dataset_path[i]}),"dots"==currDisplay?plotPositions(currPositionPaths):(currHeatmapData=formatHeatmapData(currNodeData.heatMap),heatmapInstance.setData(currHeatmapData)),plotSelectedNodes(selectedNodesList),plotNewNodes(currNodeIndices,selectedNodesList[selectedNodesList.length-1])}else currPositionPaths=dataset_path.slice(0,numPositionsMin),"dots"==currDisplay?plotPositions(currPositionPaths):(currHeatmapData=formatHeatmapData(dataset_node[0].heatMap),heatmapInstance.setData(currHeatmapData)),plotNewNodes(currNodeIndices,-1),svg.selectAll(".selectedNodesGroup").remove()}()}),d3.select("#button-dots").on("click",function(){currDisplay="dots",plotPositions(currPositionPaths),svg.selectAll(".nodes").moveToFront(),svg.selectAll(".selectedNodesGroup").moveToFront(),heatmapInstance.setData({max:0,min:0,data:[]}),d3.select(this).style("background-color",d3.rgb(79,39,79)).style("color","white"),d3.select("#button-heatmap").style("background-color","white").style("color",d3.rgb(79,39,79))}),d3.select("#button-heatmap").on("click",function(){currDisplay="heatmap",heatmapInstance.setData(currHeatmapData),svg.selectAll(".pathPoints").remove(),d3.select(this).style("background-color",d3.rgb(79,39,79)).style("color","white"),d3.select("#button-dots").style("background-color","white").style("color",d3.rgb(79,39,79))}),window.addEventListener("resize",function(){w_map=document.getElementById("graphic-svg").getBoundingClientRect().width,h_map=document.getElementById("graphic-svg").getBoundingClientRect().height,xScale_posX=d3.scaleLinear().domain([0,14700]).range([0,w_map]),yScale_posY=d3.scaleLinear().domain([0,14700]).range([h_map,0]),svg.selectAll(".pathPoints").attr("cx",function(d){return xScale_posX(d.path[currMinute-2][0])}).attr("cy",function(d){return yScale_posY(d.path[currMinute-2][1])}),svg.selectAll(".nodes").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}),svg.selectAll(".selectedLines").attr("x1",function(d,i){return xScale_posX(dataset_node[selectedNodesList[i]].pos[0])}).attr("y1",function(d,i){return yScale_posY(dataset_node[selectedNodesList[i]].pos[1])}).attr("x2",function(d,i){return xScale_posX(d.pos[0])}).attr("y2",function(d,i){return yScale_posY(d.pos[1])}),svg.selectAll(".selectedNodes").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])}),svg.selectAll(".selectedNodeRings").attr("cx",function(d){return xScale_posX(d.pos[0])}).attr("cy",function(d){return yScale_posY(d.pos[1])})})}function rowConverterNodes(d,i){return{index:i,pos:[parseInt(d.pos.split(",")[0].replace("[","")),parseInt(d.pos.split(",")[1].replace("]",""))],parent:parseInt(d.parent)||-1,pathIndices:d.pathIndices.split(",").map(function(d){return parseInt(d.replace("[",""))}),heatMap:d.heatMap.split(",").map(function(d){return parseFloat(d.replace("[[","").replace("[",""))})}}function rowConverterLookup(d){return{nodeIndices:d.nodeIndices.split(",").map(function(d){return parseInt(d.replace("[",""))})}}function rowConverterPaths(d){return{path:d.path.split("],[").map(function(d){return d.replace("[[","").replace("]]","").replace("[","").split(",").map(function(d){return parseInt(d)})})}}d3.csv("Data/bLookupTable.csv",rowConverterLookup,function(data_bLookup){d3.csv("Data/bNodeList.csv",rowConverterNodes,function(data_bNodeList){d3.csv("Data/bPathList.csv",rowConverterPaths,function(data_bPathList){d3.csv("Data/rLookupTable.csv",rowConverterLookup,function(data_rLookup){d3.csv("Data/rNodeList.csv",rowConverterNodes,function(data_rNodeList){d3.csv("Data/rPathList.csv",rowConverterPaths,function(data_rPathList){dataset_bLookup=data_bLookup,dataset_bNodeList=data_bNodeList,dataset_bPathList=data_bPathList,dataset_rLookup=data_rLookup,dataset_rNodeList=data_rNodeList,dataset_rPathList=data_rPathList,init(),document.getElementById("loading-spinner").style.display="none"})})})})})});
